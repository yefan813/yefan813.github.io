<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="记录工作中的点滴，方便以后查阅，也能提升下文笔水平 :)">
<meta property="og:type" content="website">
<meta property="og:title" content="Evan&#39;s  技术blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Evan&#39;s  技术blog">
<meta property="og:description" content="记录工作中的点滴，方便以后查阅，也能提升下文笔水平 :)">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Evan&#39;s  技术blog">
<meta name="twitter:description" content="记录工作中的点滴，方便以后查阅，也能提升下文笔水平 :)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Evan's  技术blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4355be922665db7b085a291ab1396e63";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Evan's  技术blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-search">
          <a href="/搜索" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            搜索
          </a>
        </li>
      
        
        <li class="menu-item menu-item-福利">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            福利
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/25/jstack使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/25/jstack使用/" itemprop="url">Java内存泄漏分析系列之一：使用jstack定位线程堆栈信息</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-25T16:36:19+08:00">
                2018-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/25/jstack使用/" class="leancloud_visitors" data-flag-title="Java内存泄漏分析系列之一：使用jstack定位线程堆栈信息">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载自<a href="https://www.javatang.com/archives/2017/10/19/33151873.html" target="_blank" rel="noopener">这里</a></p>
<p>上线的系统升级之后，出现了严重的高CPU的问题</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>在对Java内存泄漏进行分析的时候，需要对jvm运行期间的内存占用、线程执行等情况进行记录的dump文件，常用的主要有thread dump和heap dump。</p>
<blockquote>
<ul>
<li>thread dump 主要记录JVM在某一时刻各个线程执行的情况，以栈的形式显示，是一个文本文件。通过对thread dump文件可以分析出程序的问题出现在什么地方，从而定位具体的代码然后进行修正。thread dump需要结合占用系统资源的线程id进行分析才有意义。</li>
<li>heap dump 主要记录了在某一时刻JVM堆中对象使用的情况，即某个时刻JVM堆的快照，是一个二进制文件，主要用于分析哪些对象占用了太对的堆空间，从而发现导致内存泄漏的对象。</li>
</ul>
</blockquote>
<p>上面两种dump文件都具有实时性，因此需要在服务器出现问题的时候生成，并且多生成几个文件，方便进行对比分析。下面我们先来说一下如何生成 thread dump。</p>
<h2 id="使用jstack生成thread-dump"><a href="#使用jstack生成thread-dump" class="headerlink" title="使用jstack生成thread dump"></a>使用<a href="http://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstack.html" target="_blank" rel="noopener">jstack</a>生成thread dump</h2><p>当服务器出现高CPU的时候，首先执行 top -c 命令动态显示进程及占用资源的排行，如下图：<br><img src="https://www.javatang.com/wp-content/uploads/2017/10/top-result.png" alt=""><br>top后面的参数-c可以显示进程详细的信息。top命令执行的时候还可以执行一些快捷键：</p>
<blockquote>
<ul>
<li>1 对于多核服务器，可以显示各个CPU占用资源的情况</li>
<li>shift+h 显示所有的线程信息</li>
<li>shift+w 将当前 top 命令的设置保存到 ~/.toprc 文件中，这样不用每次都执行快捷键了</li>
</ul>
</blockquote>
<p>以上图为例，pid为1503的进程占用了大量的CPU资源，接下来需要将占用CPU最高进程中的”线程”打印出来，可以用 top -bn1 -H -p <pid> 命令，执行结果如下：<br><img src="https://www.javatang.com/wp-content/uploads/2017/10/top-threads.png" alt=""></pid></p>
<p>上面 -bn1 参数的含义是只输出一次结果，而不是显示一个动态的结果。</p>
<p>我个人请喜欢用 ps -mp <pid> -o THREAD,tid,time | sort -k2r 命令查看，后面的sort参数根据线程占用的cpu比例进行排序，结果如下：<br><img src="https://www.javatang.com/wp-content/uploads/2017/10/ps-mp-threads.png" alt=""><br>接下来我们清楚今天的主角 jstack，这是一个在JDK5开始提供的内置工具，可以打印指定进程中线程运行的状态，包括线程数量、是否存在死锁、资源竞争情况和线程的状态等等。有下面的几个常用的参数：</pid></p>
<ul>
<li>-l 长列表，打印关于锁的附加信息</li>
<li>-m 打印java和jni框架的所有栈信息</li>
</ul>
<p>因为thread id在栈信息中是以十六进制的形式显示的，因此需要使用 printf “%x \n” “tid” 命令将现场id转成十六进制的值，然后执行 jstack -l “pid” | grep “thread-hex-id” -A 10 命令显示出错的堆栈信息，如下图<br><img src="https://www.javatang.com/wp-content/uploads/2017/10/jstack-thread-id-result.png" alt=""></p>
<p>上面命令中 -A 10 参数用来指定显示行数，否则只会显示一行信息。</p>
<p>这样通过上图，可以很快地定位到程序问题的代码，然后对代码进行分析和改进即可。<strong>注意：需要在多个时间段提出多个 Thread Dump信息，然后综合进行对比分析，单独分析一个文件是没有意义的。</strong></p>
<p>上面讲述了整个的分析过程，不过所有的命令就是实时的，所以最好创建一个shell脚本瞬间执行完成，下面对 <a href="https://www.jianshu.com/p/90579ec3113f" target="_blank" rel="noopener">当CPU飙高时，它在做什么</a> 这篇文章中所提供的shell进行了改进如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">if [ $# -ne 1 ]; then</span><br><span class="line">    echo &quot;usage: $0 &lt;pid&gt; [line-number]&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># java home</span><br><span class="line">if test -z $JAVA_HOME </span><br><span class="line">then</span><br><span class="line">    JAVA_HOME=&apos;/usr/local/jdk&apos;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#pid</span><br><span class="line">pid=$1</span><br><span class="line"># checking pid</span><br><span class="line">if test -z &quot;$($JAVA_HOME/bin/jps -l | cut -d &apos;&apos; -f 1 | grep $pid)&quot;</span><br><span class="line">then</span><br><span class="line">    echo &quot;process of $pid is not exists&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#line number</span><br><span class="line">if test -z $linenum</span><br><span class="line">then</span><br><span class="line">    linenum=10</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">stackfile=stack$pid.dump</span><br><span class="line">threadsfile=threads$pid.dump</span><br><span class="line"></span><br><span class="line"># generate java stack</span><br><span class="line">$JAVA_HOME/bin/jstack -l $pid &gt;&gt; $stackfile</span><br><span class="line">ps -mp $pid -o THREAD,tid,time | sort -k2r | awk &apos;&#123;if ($1 !=&quot;USER&quot; &amp;&amp; $2 != &quot;0.0&quot; &amp;&amp; $8 !=&quot;-&quot;) print $8;&#125;&apos; | xargs printf &quot;%x\n&quot; &gt;&gt; $threadsfile</span><br><span class="line">tids=&quot;$(cat $threadsfile)&quot;</span><br><span class="line">for tid in $tids</span><br><span class="line">do</span><br><span class="line">    echo &quot;------------------------------ ThreadId ($tid) ------------------------------&quot;</span><br><span class="line">    cat $stackfile | grep 0x$tid -A $linenum</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">rm -f $stackfile $threadsfile</span><br></pre></td></tr></table></figure>
<h4 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h4><p><a href="http://www.cnblogs.com/toSeeMyDream/p/7151635.html" target="_blank" rel="noopener">java程序性能分析之thread dump和heap dump</a><br><a href="http://www.cnblogs.com/chengJAVA/p/5821218.html" target="_blank" rel="noopener">JVM调优之jstack找出最耗cpu的线程并定位代码</a><br><a href="https://www.jianshu.com/p/90579ec3113f" target="_blank" rel="noopener">当CPU飙高时，它在做什么</a><br><a href="http://www.blogjava.net/ldwblog/archive/2016/12/22/432166.html" target="_blank" rel="noopener">JAVA应用CPU占用100%|内存泄漏分析总结</a><br><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstack.html" target="_blank" rel="noopener">官网</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/24/jmap-MAT-内存溢出/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/24/jmap-MAT-内存溢出/" itemprop="url">Java内存泄漏分析系列之七：jmap + MAT 内存溢出</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-24T23:45:47+08:00">
                2018-07-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/24/jmap-MAT-内存溢出/" class="leancloud_visitors" data-flag-title="Java内存泄漏分析系列之七：jmap + MAT 内存溢出">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载自：<a href="https://www.javatang.com/archives/2017/11/08/11582145.html" target="_blank" rel="noopener">传送门</a></p>
<h3 id="手动构建堆内存溢出："><a href="#手动构建堆内存溢出：" class="headerlink" title="手动构建堆内存溢出："></a>手动构建堆内存溢出：</h3><p>使用 asm 构造 class，后面模拟非堆内存溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * https://blog.csdn.net/bolg_hero/article/details/78189621</span><br><span class="line"> * 继承ClassLoader是为了方便调用defineClass方法，因为该方法的定义为protected</span><br><span class="line"> * */</span><br><span class="line">public class Metaspace extends ClassLoader &#123;</span><br><span class="line">	</span><br><span class="line">    public static List&lt;Class&lt;?&gt;&gt; createClasses() &#123;</span><br><span class="line">        // 类持有</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">        // 循环1000w次生成1000w个不同的类。</span><br><span class="line">        for (int i = 0; i &lt; 10000000; ++i) &#123;</span><br><span class="line">            ClassWriter cw = new ClassWriter(0);</span><br><span class="line">            // 定义一个类名称为Class&#123;i&#125;，它的访问域为public，父类为java.lang.Object，不实现任何接口</span><br><span class="line">            cw.visit(Opcodes.V1_1, Opcodes.ACC_PUBLIC, &quot;Class&quot; + i, null,</span><br><span class="line">                    &quot;java/lang/Object&quot;, null);</span><br><span class="line">            // 定义构造函数&lt;init&gt;方法</span><br><span class="line">            MethodVisitor mw = cw.visitMethod(Opcodes.ACC_PUBLIC, &quot;&lt;init&gt;&quot;,</span><br><span class="line">                    &quot;()V&quot;, null, null);</span><br><span class="line">            // 第一个指令为加载this</span><br><span class="line">            mw.visitVarInsn(Opcodes.ALOAD, 0);</span><br><span class="line">            // 第二个指令为调用父类Object的构造函数</span><br><span class="line">            mw.visitMethodInsn(Opcodes.INVOKESPECIAL, &quot;java/lang/Object&quot;,</span><br><span class="line">                    &quot;&lt;init&gt;&quot;, &quot;()V&quot;);</span><br><span class="line">            // 第三条指令为return</span><br><span class="line">            mw.visitInsn(Opcodes.RETURN);</span><br><span class="line">            mw.visitMaxs(1, 1);</span><br><span class="line">            mw.visitEnd();</span><br><span class="line">            Metaspace test = new Metaspace();</span><br><span class="line">            byte[] code = cw.toByteArray();</span><br><span class="line">            // 定义类</span><br><span class="line">            Class&lt;?&gt; exampleClass = test.defineClass(&quot;Class&quot; + i, code, 0, code.length);</span><br><span class="line">            classes.add(exampleClass);</span><br><span class="line">        &#125;</span><br><span class="line">        return classes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内存溢出使用的对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 名称</span><br><span class="line">     */</span><br><span class="line">    private String name;</span><br><span class="line">    /**</span><br><span class="line">     * 年龄</span><br><span class="line">     */</span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    public User() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User(String name, int age) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="http-请求"><a href="#http-请求" class="headerlink" title="http 请求"></a>http 请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/&quot;)</span><br><span class="line">public class MemoryController &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private List&lt;User&gt; userList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private List&lt;Class&lt;?&gt;&gt; clazzList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 记得设置启动参数 -Xmx16M -Xms16M</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/heap&quot;)</span><br><span class="line">    public String heap()&#123;</span><br><span class="line">        int i = 0 ;</span><br><span class="line">        while(true)&#123;</span><br><span class="line">            userList.add(new User(UUID.randomUUID().toString(), i++));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 记得设置启动参数 -XX:MetaspaceSize=32M -XX:MaxMetaspaceSize=32M</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/nonHeap&quot;)</span><br><span class="line">    public String nonHeap()&#123;</span><br><span class="line">        while(true)&#123;</span><br><span class="line">            clazzList.addAll(Metaspace.createClasses());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模拟堆内存溢出时设置启动参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx16M -Xms16M</span><br></pre></td></tr></table></figure>
<p>模拟非堆内存溢出时设置启动参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:MetaspaceSize=32M </span><br><span class="line">-XX:MaxMetaspaceSize=32M</span><br></pre></td></tr></table></figure>
<p>内存溢出自动导出映像文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:HeapDumpPath=./</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1ftlxgs9q5xj30qs04uq4d.jpg" alt=""></p>
<p>可以看到这里自动导出了堆内存快照</p>
<h3 id="还可以-jmap-手动导出快照"><a href="#还可以-jmap-手动导出快照" class="headerlink" title="还可以 jmap 手动导出快照"></a>还可以 jmap 手动导出快照</h3><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ftlxl6lctoj31100rcgqd.jpg" alt=""></p>
<p>使用说明：<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jmap.html#CEGCECJB" target="_blank" rel="noopener">链接</a></p>
<p>使用方式：<br>1，jps 查看 java 进程<br><code>jps -l</code><br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftlxn9h6nbj30rs04s0ti.jpg" alt=""></p>
<p>2, jmap导出堆快照<br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftlxptn6b9j30sa03e3yz.jpg" alt=""></p>
<h2 id="堆内存导出之后使用-MAT-分析内存溢出"><a href="#堆内存导出之后使用-MAT-分析内存溢出" class="headerlink" title="堆内存导出之后使用 MAT 分析内存溢出"></a>堆内存导出之后使用 MAT 分析内存溢出</h2><p>MAT 打开之后是这样<br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftlyk4nfx3j31kw0sf11f.jpg" alt=""></p>
<p>MAT 分析结果<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ftlynwu1qoj30oy0cq76m.jpg" alt=""></p>
<p>这里可以看到最大对象的相关信息<br><img src="https://ws2.sinaimg.cn/large/006tNc79gy1ftlytnxktvj30zr0n3dkv.jpg" alt=""></p>
<p>界面功能介绍：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ftlz0ctbz8j30m30j27a5.jpg" alt=""></p>
<h3 id="这里需要介绍一下-Shallow-Heap-和-Retained-Heap概念"><a href="#这里需要介绍一下-Shallow-Heap-和-Retained-Heap概念" class="headerlink" title="这里需要介绍一下 Shallow Heap 和 Retained Heap概念"></a>这里需要介绍一下 Shallow Heap 和 Retained Heap概念</h3><p>Shallow Heap 和 Retained Heap</p>
<p>Shallow Heap表示对象本身占用内存的大小，不包含对其他对象的引用，也就是对象头加成员变量（不是成员变量的值）的总和。</p>
<p>Retained Heap是该对象自己的Shallow Heap，并加上从该对象能直接或间接访问到对象的Shallow Heap之和。换句话说，Retained Heap是该对象GC之后所能回收到内存的总和。</p>
<p>把内存中的对象看成下图中的节点，并且对象和对象之间互相引用。这里有一个特殊的节点GC Roots，这就是reference chain的起点。</p>
<p><img src="https://www.javatang.com/wp-content/uploads/2017/11/retained_objects.png" alt=""></p>
<p>从obj1入手，上图中蓝色节点代表仅仅只有通过obj1才能直接或间接访问的对象。因为可以通过GC Roots访问，所以左图的obj3不是蓝色节点；而在右图却是蓝色，因为它已经被包含在retained集合内。所以对于左图，obj1的retained size是obj1、obj2、obj4的shallow size总和；右图的retained size是obj1、obj2、obj3、obj4的shallow size总和。obj2的retained size可以通过相同的方式计算。</p>
<h4 id="对象引用（Reference）"><a href="#对象引用（Reference）" class="headerlink" title="对象引用（Reference）"></a>对象引用（Reference）</h4><p>对象引用按从最强到最弱有如下级别，不同的引用（可到达性）级别反映了对象的生命周期：</p>
<ol>
<li>强引用（Strong Ref）：通常我们编写的代码都是强引用，于此相对应的是强可达性，只有去掉强可达性，对象才能被回收。</li>
<li>软引用（Soft Ref）：对应软可达性，只要有足够的内存就一直保持对象，直到发现内存不足且没有强引用的时候才回收对象。</li>
<li>弱引用（Weak Ref）：比软引用更弱，当发现不存在强引用的时候会立即回收此类型的对象，而不需要等到内存不足。通过java.lang.ref.WeakReference和java.util.WeakHashMap类实现。</li>
<li>虚引用（Phantom Ref）：根本不会在内存中保持该类型的对象，只能使用虚引用本身，一般用于在进入finalize()方法后进行特殊的清理过程，通过java.lang.ref.PhantomReference实现。</li>
</ol>
<h3 id="GC-Roots和Reference-Chain"><a href="#GC-Roots和Reference-Chain" class="headerlink" title="GC Roots和Reference Chain"></a>GC Roots和Reference Chain</h3><p>JVM在进行GC的时候是通过使用可达性来判断对象是否存活，通过GC Roots（GC根节点）的对象作为起始点，从这些节点开始进行向下搜索，搜索所走过的路径成为Reference Chain（引用链），当一个对象到GC Roots没有任何引用链相连（用图论的话来说就是从GC Roots到这个对象不可达）时，则证明此对象是不可用的。</p>
<p>如下图所示，对象object 5、object 6、object 7虽然互相有关联，它们的引用并不为0，但是它们到GC Roots是不可达的，因此它们将会被判定为是可回收的对象。<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/gc-roots.jpg" alt=""></p>
<h3 id="Histogram（直方图）视图"><a href="#Histogram（直方图）视图" class="headerlink" title="Histogram（直方图）视图"></a>Histogram（直方图）视图</h3><p>点击工具栏上的<img src="https://www.javatang.com/wp-content/uploads/2017/10/fe892b246b43fa64b866790a2f256859.png" alt="">图标可以打开Histogram（直方图）视图，可以列出每个类产生的实例数量，以及所占用的内存大小和百分比。主界面如下图所示：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ftlzb7iod1j30tj0mwn36.jpg" alt=""></p>
<p>图中Shallow Heap 和 Retained Heap分别表示对象自身不包含引用的大小和对象自身并包含引用的大小，具体请参考下面 Shallow Heap 和 Retained Heap 部分的内容。默认的大小单位是 Bytes，可以在 Window - Preferences 菜单中设置单位。</p>
<p>通过直方图视图可以很容易找到占用内存最多的几个类（通过Retained Heap排序），还可以通过其他方式进行分组（见下图）。<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/332724b74c697a72e19c94cf4188bee2.png" alt=""><br>如果存在内存溢出，时间久了溢出类的实例数量或者内存占比会越来越多，排名也越来越靠前。可以点击工具类上的<img src="https://www.javatang.com/wp-content/uploads/2017/11/b0f463b6011fdfb7cc6c7b0826ac97e5.png" alt="">图标进行对比，通过多次对比不同时间点下的直方图对比就很容易把溢出的类找出来，这里是对比多个对快照。</p>
<p>还有一种对比直方图的方式，首先通过 Window 菜单打开 Navigation History 视图，选中直方图右键并选中 Add to Compare Basket项目，将直方图添加到 Compare Basket 中。</p>
<p><img src="https://www.javatang.com/wp-content/uploads/2017/11/548db33968616d6ce2ea2d87f8b8bb57.png" alt=""><br>然后在 Compare Basket 中点击右上角的  按钮，可以分别列出对比的所有结果，见下图：<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/1e3ec66f66b72a05eec686a24c2c4df6.png" alt=""><br>并且在上面的可以设置不同的对比方式。<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/cb8e6e3c8bc871bd0d65a952aa572b94.png" alt=""></p>
<h3 id="Dominator-Tree视图"><a href="#Dominator-Tree视图" class="headerlink" title="Dominator Tree视图"></a>Dominator Tree视图</h3><p>点击工具栏上的<img src="https://www.javatang.com/wp-content/uploads/2017/10/5931b0544ead20fc50aba5efd828385e.png" alt="">图标可以打开Dominator Tree（支配树）视图，在此视图中列出了每个对象（Object Instance）与其引用关系的树状结构，同时包含了占用内存的大小和百分比。<br><img src="https://ws1.sinaimg.cn/large/006tNc79gy1ftlzl15q38j30tf0lm47m.jpg" alt=""><br>通过Dominator Tree视图可以很容易的找出占用内存最多的几个对象（根据Retained Heap或Percentage排序），和Histogram类似，可以通过不同的方式进行分组显示：<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/2235da535545f94b3233c22f0eea1302.png" alt=""></p>
<h3 id="重点：定位溢出源"><a href="#重点：定位溢出源" class="headerlink" title="重点：定位溢出源"></a>重点：定位溢出源</h3><p>Histogram视图和Dominator Tree视图的角度不同，前者是基于类的角度，后者是基于对象实例的角度，并且可以更方便的看出其引用关系。</p>
<p>首先，在两个视图中找出疑似溢出的对象或者类（可以通过Retained Heap排序，并且可以在Class Name中输入正则表达式的关键词只显示指定的类名），然后右键选择Path To GC Roots（Histogram中没有此项）或Merge Shortest Paths to GC Roots，然后选择 exclude all phantom/weak/soft etc. reference：<br><img src="https://www.javatang.com/wp-content/uploads/2017/11/0a35317d8a0291b8c5c6672ff6d17d0e.png" alt=""><br>GC Roots意为GC根节点，其含义见上面的 GC Roots和Reference Chain 部分，后面的 exclude all phantom/weak/soft etc. reference 意思是排除虚引用、弱引用和软引用，即只剩下强引用，因为除了强引用之外，其他的引用都可以被JVM GC掉，如果一个对象始终无法被GC，就说明有强引用存在，从而导致在GC的过程中一直得不到回收，最终就内存溢出了。</p>
<p>通过结果就可以很方便的定位到具体的代码，然后分析是什么原因无法释放该对象，比如被缓存了或者没有使用单例模式等等。</p>
<p>下面是执行的结果：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ftlzp79sm7j30sp0kdgsc.jpg" alt=""><br>上图中保留了大量的user 引用，和我们手动制造的内存溢出对应</p>
<h3 id="后续观察"><a href="#后续观察" class="headerlink" title="后续观察"></a>后续观察</h3><p>上面是一个非常简单的内存异常分析过程，生产环境情况会复杂很多。<br>生产环境根据上面分析的结果对问题进行处理之后，再对照之前的操作，看看对象是否还再持续增长，如果没有就说明这个地方的问题已经解决了。</p>
<p>最后再用 jstat 持续跟踪一段时间，看看Old和Perm区的内存是否最终稳定在一个范围之内，如果长时间稳定在一个范围说明溢出问题得到了解决，否则还要继续进行分析和处理，一直到稳定为止。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/23/jvm概览/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/23/jvm概览/" itemprop="url">jvm概览</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-23T23:54:55+08:00">
                2018-07-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/23/jvm概览/" class="leancloud_visitors" data-flag-title="jvm概览">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JVM参数类型"><a href="#JVM参数类型" class="headerlink" title="JVM参数类型"></a>JVM参数类型</h2><ul>
<li>标准参数</li>
<li>X 参数</li>
<li>XX 参数</li>
</ul>
<h3 id="标准参数"><a href="#标准参数" class="headerlink" title="标准参数"></a>标准参数</h3><ul>
<li>-help</li>
<li>-server :选择 “server” VM,默认 VM 是 server,因为您是在服务器类计算机上运行</li>
<li>-client</li>
<li>-version :输出产品版本并退出</li>
<li>-showversion :输出产品版本并继续</li>
<li>-cp :&lt;目录和 zip/jar 文件的类搜索路径&gt;</li>
<li>-classpath:&lt;目录和 zip/jar 文件的类搜索路径&gt;用 : 分隔的目录, JAR 档案和 ZIP 档案列表, 用于搜索类文件。</li>
</ul>
<h3 id="非标准参数-X"><a href="#非标准参数-X" class="headerlink" title="非标准参数: -X"></a>非标准参数: -X</h3><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ftk8xya9lnj314415gk3n.jpg" alt=""><br>例如：<br><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ftk921u5dsj31120fgae8.jpg" alt=""></p>
<h3 id="XX参数分类"><a href="#XX参数分类" class="headerlink" title="XX参数分类"></a>XX参数分类</h3><ul>
<li>Boolean类型</li>
</ul>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1ftk93moo66j30p806dtad.jpg" alt=""></p>
<ul>
<li><p>非 Boolean 类型<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ftk97wn9i8j30qo065abs.jpg" alt=""></p>
</li>
<li><p>-Xmx -Xms<br><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ftk9ay3x0kj30xj0e2mzu.jpg" alt=""></p>
</li>
</ul>
<h2 id="查看-JVM-运行时参数"><a href="#查看-JVM-运行时参数" class="headerlink" title="查看 JVM 运行时参数"></a>查看 JVM 运行时参数</h2><ul>
<li>-XX:+PrintFlagsInitial 打印初始值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#java  -XX:+PrintFlagsInitial -version ##显示当前命令进程的参数信息</span><br></pre></td></tr></table></figure>
<ul>
<li>-XX:+PrintFlagsFinal 打印最终值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#java  -XX:+PrintFlagsFinal -version ##显示当前命令进程的参数信息</span><br></pre></td></tr></table></figure>
<ul>
<li>-XX:+UnlockExperimentalVMOptions解锁实验参数 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#java  -XX:+UnlockExperimentalVMOptions -version ##显示当前命令进程的参数信息</span><br></pre></td></tr></table></figure>
<ul>
<li>-XX:+UnlockDiagnosticOptions解锁诊断参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#java  -XX:+UnlockDiagnosticOptions -version ##显示当前命令进程的参数信息</span><br></pre></td></tr></table></figure>
<h3 id="JPS"><a href="#JPS" class="headerlink" title="JPS"></a>JPS</h3><p><code>jps [ options ] [ hostid ]</code><br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1ftk9x9pvm5j30x80cnabp.jpg" alt=""></p>
<h3 id="jinfo-查看运行时参数"><a href="#jinfo-查看运行时参数" class="headerlink" title="jinfo 查看运行时参数"></a>jinfo 查看运行时参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">jinfo [ option ] pid</span><br><span class="line"></span><br><span class="line">jinfo [ option ] executable core</span><br><span class="line"></span><br><span class="line">jinfo [ option ] [ servier-id ] remote-hostname-or-IP</span><br><span class="line"></span><br><span class="line">option</span><br><span class="line">The command-line options. See Options.</span><br><span class="line"></span><br><span class="line">pid</span><br><span class="line">The process ID for which the configuration information is to be printed. The process must be a Java process. To get a list of Java processes running on a machine, use the jps(1) command.</span><br><span class="line"></span><br><span class="line">executable</span><br><span class="line">The Java executable from which the core dump was produced.</span><br><span class="line"></span><br><span class="line">core</span><br><span class="line">The core file for which the configuration information is to be printed.</span><br><span class="line"></span><br><span class="line">remote-hostname-or-IP</span><br><span class="line">The remote debug server hostname or IP address. See jsadebugd(1).</span><br><span class="line"></span><br><span class="line">server-id</span><br><span class="line">An optional unique ID to use when multiple debug servers are running on the same remote host.</span><br><span class="line"></span><br><span class="line">Description</span><br><span class="line">The jinfo command prints Java configuration information for a specified Java process or core file or a remote debug server. The configuration information includes Java system properties and Java Virtual Machine (JVM) command-line flags. If the specified process is running on a 64-bit JVM, then you might need to specify the -J-d64 option, for example: jinfo -J-d64 -sysprops pid.</span><br><span class="line"></span><br><span class="line">This utility is unsupported and might not be available in future releases of the JDK. In Windows Systems where dbgeng.dll is not present, Debugging Tools For Windows must be installed to have these tools working. The PATH environment variable should contain the location of the jvm.dll that is used by the target process or the location from which the crash dump file was produced. For example, set PATH=%JDK_HOME%\jre\bin\client;%PATH% .</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line">no-option</span><br><span class="line">Prints both command-line flags and system property name-value pairs.</span><br><span class="line"></span><br><span class="line">-flag name</span><br><span class="line">Prints the name and value of the specified command-line flag.</span><br><span class="line"></span><br><span class="line">-flag [+|-]name</span><br><span class="line">enables or disables the specified Boolean command-line flag.</span><br><span class="line"></span><br><span class="line">-flag name=value</span><br><span class="line">Sets the specified command-line flag to the specified value.</span><br><span class="line"></span><br><span class="line">-flags</span><br><span class="line">Prints command-line flags passed to the JVM.</span><br><span class="line"></span><br><span class="line">-sysprops</span><br><span class="line">Prints Java system properties as name-value pairs.</span><br><span class="line"></span><br><span class="line">-h</span><br><span class="line">Prints a help message.</span><br><span class="line"></span><br><span class="line">-help</span><br><span class="line">Prints a help message.</span><br></pre></td></tr></table></figure>
<p>例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">⇒  jinfo -flag MaxHeapSize 5796  ##查看最大内存</span><br><span class="line">-XX:MaxHeapSize=4294967296</span><br><span class="line"></span><br><span class="line">jinfo -flag UseConcMarkSweepGC 5796 ##查看是否垃圾回收器 +使用 -表示未使用</span><br><span class="line">-XX:-UseConcMarkSweepGC</span><br><span class="line"></span><br><span class="line">⇒  jinfo -flag UseG1GC 5796 ##查看是否垃圾回收器 +使用 -表示未使用</span><br><span class="line">-XX:-UseG1GC</span><br><span class="line"></span><br><span class="line">⇒  jinfo -flag UseParallelGC 5796 ##查看是否垃圾回收器 +使用 -表示未使用</span><br><span class="line">-XX:+UseParallelGC</span><br></pre></td></tr></table></figure>
<h3 id="jstat-查看-JVM-统计信息"><a href="#jstat-查看-JVM-统计信息" class="headerlink" title="jstat 查看 JVM 统计信息"></a>jstat 查看 JVM 统计信息</h3><ul>
<li>查看类装载信息</li>
<li>查看垃圾收集信息</li>
<li>查看JIT 编译信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">jstat [ generalOption | outputOptions vmid [ interval[s|ms] [ count ] ]</span><br><span class="line"></span><br><span class="line">generalOption: -help 、 -options</span><br><span class="line"></span><br><span class="line">outputOptions:</span><br><span class="line">class: 显示有关类加载器行为的统计信息.</span><br><span class="line"></span><br><span class="line">compiler: 显示有关Java HotSpot VM实时编译器（JIT）行为的统计信息.</span><br><span class="line"></span><br><span class="line">gc: 显示有关垃圾回收堆行为的统计信息.</span><br><span class="line"></span><br><span class="line">gccapacity: 显示有关代的容量及其相应空间的统计信息.</span><br><span class="line"></span><br><span class="line">gccause: 显示有关垃圾收集统计信息的摘要（与-gcutil相同），以及最后一个和当前（适用时）垃圾收集事件的原因.</span><br><span class="line"></span><br><span class="line">gcnew: 显示新生代行为的统计信息.</span><br><span class="line"></span><br><span class="line">gcnewcapacity: 显示有关新生代及其相应空间大小的统计信息.</span><br><span class="line"></span><br><span class="line">gcold: 显示有关老年代和元空间统计信息行为的统计信息.</span><br><span class="line"></span><br><span class="line">gcoldcapacity: 显示有关老年代大小的统计信息.</span><br><span class="line"></span><br><span class="line">gcmetacapacity: 显示有关元空间大小的统计信息.</span><br><span class="line"></span><br><span class="line">gcutil: 显示有关垃圾收集统计信息的摘要.</span><br><span class="line"></span><br><span class="line">printcompilation: 显示Java HotSpot VM编译方法统计信息.</span><br><span class="line"></span><br><span class="line">参考：[链接](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html#BEHIGDGJ)</span><br></pre></td></tr></table></figure>
<h5 id="gc-输出结果"><a href="#gc-输出结果" class="headerlink" title="-gc 输出结果"></a>-gc 输出结果</h5><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ftkaz5fm0ej311c0j7tib.jpg" alt=""></p>
<p>这里不得不提一下 JVM 内存结构：<br><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ftkb1vazonj30w40pk7eo.jpg" alt=""></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/" target="_blank" rel="noopener">官网</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/java-reference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/12/java-reference/" itemprop="url">java 引用类型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-12T18:09:43+08:00">
                2018-07-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/12/java-reference/" class="leancloud_visitors" data-flag-title="java 引用类型">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>java中提供了四个级别的引用：</strong></p>
<ol>
<li>强引用（Final Reference）</li>
<li>软引用(Soft Reference)</li>
<li>弱引用(Weak Reference)</li>
<li>虚引用(Phantom Reference)</li>
</ol>
<p><strong>这四个引用定义在java.lang.ref的包下</strong><br><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft80n8gk8uj306104o0sr.jpg" alt=""></p>
<p><strong>强引用（ Final Reference ）</strong><br> 就是指在程序代码中普遍存在的，类似Object obj = new Object()这类的引用，只要强引用还存在，垃圾收集器永远不会回收掉被引用的对象。<br>  强引用具备以下三个个特点：</p>
<blockquote>
<p>1.强引用可以直接访问目标对象；<br>2.强引用锁指向的对象在任何时候都不会被系统回收。JVM宁愿抛出OOM异常也不回收强引用所指向的对象；<br>3.强应用可能导致内存泄露；</p>
</blockquote>
<p>整个FinalReference类的定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.ref;</span><br><span class="line"><span class="comment">/* Final references, used to implement finalization */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FinalReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Reference</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FinalReference</span><span class="params">(T referent, ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(referent, q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从类定义中可以看出，只有一个构造函数，根据所给的对象的引用和引用队列构造一个强引用。</p>
<hr>
<p><strong>软引用（ Soft Reference ）</strong><br>  是用来描述一些还有用但并非必须的对象。对于软引用关联着的对象，在系统将要发生内存溢出异常之前，将会把这些对象列进回收范围之中进行第二次回收。如果这次回收还没有足够的内存，才会抛出内存溢出异常。<br>  对于软引用关联着的对象，如果内存充足，则垃圾回收器不会回收该对象，如果内存不够了，就会回收这些对象的内存。在 JDK 1.2 之后，提供了 SoftReference 类来实现软引用。软引用可用来实现内存敏感的高速缓存。软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。<br>  案例：
  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.Reference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftRefTest</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReferenceQueue&lt;MyObject&gt; softQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;(); <span class="comment">//引用队列</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObject</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 垃圾回收器准备释放内存的时候，会先调用finalize()</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.finalize();</span><br><span class="line">            System.out.println(<span class="string">"MyObject's finalize called"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"I am MyObject"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckRefQueue</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        Reference&lt;MyObject&gt; obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                obj = (Reference&lt;MyObject&gt;)softQueue.remove();  <span class="comment">//如果队列没有数据一致阻塞等待</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(obj != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">"Object for SoftReference is "</span>+obj.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyObject object = <span class="keyword">new</span> MyObject();</span><br><span class="line">        SoftReference&lt;MyObject&gt; softRef = <span class="keyword">new</span> SoftReference&lt;&gt;(object,softQueue);</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> CheckRefQueue()).start();</span><br><span class="line"></span><br><span class="line">        object = <span class="keyword">null</span>;    <span class="comment">//删除强引用</span></span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">"After GC: Soft Get= "</span>+softRef.get());</span><br><span class="line">        System.out.println(<span class="string">"分配大块内存"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">5</span>*<span class="number">1024</span>*<span class="number">928</span>];</span><br><span class="line">        System.out.println(<span class="string">"After new byte[]:Soft Get= "</span>+softRef.get());</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行参数1：<br><code>-Xmx5M</code></p>
<p>运行结果1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">After GC: Soft Get= I am MyObject</span><br><span class="line">分配大块内存</span><br><span class="line">MyObject&apos;s finalize called</span><br><span class="line">Object for SoftReference is null</span><br><span class="line">After new byte[]:Soft Get= null</span><br></pre></td></tr></table></figure>
<p>运行参数2：</p>
<p><code>-Xmx5M -XX:PrintGCDetails</code></p>
<p>运行结果2（关于GC日志可以查看《Java堆内存<a href="http://blog.csdn.net/u013256816/article/details/50764532》）：" target="_blank" rel="noopener">http://blog.csdn.net/u013256816/article/details/50764532》）：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[GC [PSYoungGen: 680K-&gt;504K(2560K)] 680K-&gt;512K(6144K), 0.0040658 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC [PSYoungGen: 504K-&gt;0K(2560K)] [ParOldGen: 8K-&gt;482K(3584K)] 512K-&gt;482K(6144K) [PSPermGen: 2491K-&gt;2490K(21504K)], 0.0188479 secs] [Times: user=0.01 sys=0.00, real=0.02 secs] </span><br><span class="line">After GC: Soft Get= I am MyObject</span><br><span class="line">分配大块内存</span><br><span class="line">[GC [PSYoungGen: 123K-&gt;64K(2560K)] 605K-&gt;546K(7680K), 0.0004285 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC [PSYoungGen: 64K-&gt;64K(2560K)] 546K-&gt;546K(7680K), 0.0003019 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC [PSYoungGen: 64K-&gt;0K(2560K)] [ParOldGen: 482K-&gt;482K(4608K)] 546K-&gt;482K(7168K) [PSPermGen: 2493K-&gt;2493K(21504K)], 0.0094748 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] </span><br><span class="line">[GC [PSYoungGen: 0K-&gt;0K(2560K)] 482K-&gt;482K(7680K), 0.0003759 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC [PSYoungGen: 0K-&gt;0K(2560K)] [ParOldGen: 482K-&gt;472K(5120K)] 482K-&gt;472K(7680K) [PSPermGen: 2493K-&gt;2493K(21504K)], 0.0101017 secs] [Times: user=0.06 sys=0.00, real=0.01 secs] </span><br><span class="line">MyObject&apos;s finalize called</span><br><span class="line">Object for SoftReference is null</span><br><span class="line">After new byte[]:Soft Get= null</span><br><span class="line">[GC [PSYoungGen: 122K-&gt;32K(2560K)] 5235K-&gt;5144K(7680K), 0.0004806 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC [PSYoungGen: 32K-&gt;0K(2560K)] [ParOldGen: 5112K-&gt;5112K(5120K)] 5144K-&gt;5112K(7680K) [PSPermGen: 2493K-&gt;2493K(21504K)], 0.0136270 secs] [Times: user=0.06 sys=0.00, real=0.01 secs] </span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 2560K, used 20K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</span><br><span class="line">  eden space 2048K, 1% used [0x00000000ffd00000,0x00000000ffd05250,0x00000000fff00000)</span><br><span class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</span><br><span class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</span><br><span class="line"> ParOldGen       total 5120K, used 5112K [0x00000000ff800000, 0x00000000ffd00000, 0x00000000ffd00000)</span><br><span class="line">  object space 5120K, 99% used [0x00000000ff800000,0x00000000ffcfe188,0x00000000ffd00000)</span><br><span class="line"> PSPermGen       total 21504K, used 2500K [0x00000000fa600000, 0x00000000fbb00000, 0x00000000ff800000)</span><br><span class="line">  object space 21504K, 11% used [0x00000000fa600000,0x00000000fa871190,0x00000000fbb00000)</span><br></pre></td></tr></table></figure>
<p>加入 -XX:PrintGCDetails参数运行可以更形象的看到GC回收的细节。<br>  这个案例1中，首先构造MyObject对象，并将其赋值给object变量，构成强引用。然后使用SoftReference构造这个MyObject对象的软引用softRef，并注册到softQueue引用队列。当softRef被回收时，会被加入softQueue队列。设置obj=null，删除这个强引用，因此，系统内对MyObject对象的引用只剩下软引用。此时，显示调用GC，通过软引用的get()方法，取得MyObject对象的引用，发现对象并未被回收，这说明GC在内存充足的情况下，不会回收软引用对象。<br>  接着，请求一块大的堆空间5<em>1024</em>928，这个操作会使系统堆内存使用紧张，从而产生新一轮的GC。在这次GC后，softRef.get()不再返回MyObject对象，而是返回null，说明在系统内存紧张的情况下，软引用被回收。软引用被回收时，会被加入注册的引用队列。<br>   如果将上面案例中的数组再改大点，比如5<em>1024</em>1024，就会抛出OOM异常：
   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">After GC: Soft Get= I am MyObject</span><br><span class="line">分配大块内存</span><br><span class="line">MyObject&apos;s finalize called</span><br><span class="line">Object for SoftReference is null</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at collections.ref.SoftRefTest.main(SoftRefTest.java:58)</span><br></pre></td></tr></table></figure>
<p>软引用主要应用于内存敏感的高速缓存，在android系统中经常使用到。一般情况下，Android应用会用到大量的默认图片，这些图片很多地方会用到。如果每次都去读取图片，由于读取文件需要硬件操作，速度较慢，会导致性能较低。所以我们考虑将图片缓存起来，需要的时候直接从内存中读取。但是，由于图片占用内存空间比较大，缓存很多图片需要很多的内存，就可能比较容易发生OutOfMemory异常。这时，我们可以考虑使用软引用技术来避免这个问题发生。SoftReference可以解决oom的问题，每一个对象通过软引用进行实例化，这个对象就以cache的形式保存起来，当再次调用这个对象时，那么直接通过软引用中的get（）方法，就可以得到对象中中的资源数据，这样就没必要再次进行读取了，直接从cache中就可以读取得到，当内存将要发生OOM的时候，GC会迅速把所有的软引用清除，防止oom发生。</p>
<hr>
<p><strong>弱引用（ Weak Reference ）</strong><br>    用来描述非必须的对象，但是它的强度比软引用更弱一些，被弱引用关联的对象只能生存到下一次垃圾收集发送之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。一旦一个弱引用对象被垃圾回收器回收，便会加入到一个注册引用队列中。<br>  我们略微修改一下案例1的代码，如下：
  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">package collections.ref;</span><br><span class="line"></span><br><span class="line">import java.lang.ref.Reference;</span><br><span class="line">import java.lang.ref.ReferenceQueue;</span><br><span class="line">import java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line">public class WeakRefTest</span><br><span class="line">&#123;</span><br><span class="line">    private static ReferenceQueue&lt;MyObject&gt; weakQueue = new ReferenceQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public static class MyObject&#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        protected void finalize() throws Throwable</span><br><span class="line">        &#123;</span><br><span class="line">            super.finalize();</span><br><span class="line">            System.out.println(&quot;MyObject&apos;s finalize called&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString()</span><br><span class="line">        &#123;</span><br><span class="line">            return &quot;I am MyObject&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class CheckRefQueue implements Runnable</span><br><span class="line">    &#123;</span><br><span class="line">        Reference&lt;MyObject&gt; obj = null;</span><br><span class="line">        @Override</span><br><span class="line">        public void run()</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                obj = (Reference&lt;MyObject&gt;)weakQueue.remove(); //阻塞等待</span><br><span class="line">            &#125;</span><br><span class="line">            catch (InterruptedException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            if(obj != null)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(&quot;删除的弱引用为：&quot;+obj+&quot;  but获取弱引用的对象obj.get()=&quot;+obj.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        MyObject object = new MyObject();</span><br><span class="line">        Reference&lt;MyObject&gt; weakRef = new WeakReference&lt;&gt;(object,weakQueue);</span><br><span class="line">        System.out.println(&quot;创建的弱引用为：&quot;+weakRef);</span><br><span class="line">        new Thread(new CheckRefQueue()).start();</span><br><span class="line"></span><br><span class="line">        object = null;</span><br><span class="line">        System.out.println(&quot;Before GC: Weak Get= &quot;+weakRef.get());</span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(&quot;After GC: Weak Get= &quot;+weakRef.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不加参数运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建的弱引用为：java.lang.ref.WeakReference@<span class="number">29e07</span>d3e</span><br><span class="line">Before GC: Weak Get= I am MyObject</span><br><span class="line">After GC: Weak Get= <span class="keyword">null</span></span><br><span class="line">MyObject<span class="string">'s finalize called</span></span><br><span class="line"><span class="string">删除的弱引用为：java.lang.ref.WeakReference@29e07d3e  but获取弱引用的对象obj.get()=null</span></span><br></pre></td></tr></table></figure>
<p>可以看到，在GC之前，弱引用对象并未被垃圾回收器发现，因此通过 weakRef.get()可以获取对应的对象引用。但是只要进行垃圾回收，弱引用一旦被发现，便会立即被回收，并加入注册引用队列中。此时再试图通过weakRef.get()获取对象的引用就会失败。</p>
<blockquote>
<p>软引用、弱引用都非常适合来保存那些可有可无的缓存数据。如果这么做，当系统内存不足时，这些缓存数据会被回收，不会导致内存溢出。而当内存资源充足时，这些缓存数据又可以存在相当长的时间，从而起来加速系统的作用。</p>
</blockquote>
<hr>
<p><strong>虚引用（Phantom Reference)</strong></p>
<p>虚引用（Phantom Reference)<br>  虚引用也称为幽灵引用或者幻影引用，它是最弱的一种引用关系。一个持有虚引用的对象，和没有引用几乎是一样的，随时都有可能被垃圾回收器回收。当试图通过虚引用的get()方法取得强引用时，总是会失败。并且，虚引用必须和引用队列一起使用，它的作用在于跟踪垃圾回收过程。<br>  虚引用中get方法的实现如下：
  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到永远返回null.<br>  我们再来修改一下案例1的代码：<br>  <br>  <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> collections.ref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.PhantomReference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.Reference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhantomRefTest</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReferenceQueue&lt;MyObject&gt; phanQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObject</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.finalize();</span><br><span class="line">            System.out.println(<span class="string">"MyObject's finalize called"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"I am MyObject"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckRefQueue</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        Reference&lt;MyObject&gt; obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                obj = (Reference&lt;MyObject&gt;)phanQueue.remove();</span><br><span class="line">                System.out.println(<span class="string">"删除的虚引用为："</span>+obj+<span class="string">"  but获取虚引用的对象obj.get()="</span>+obj.get());</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyObject object = <span class="keyword">new</span> MyObject();</span><br><span class="line">        Reference&lt;MyObject&gt; phanRef = <span class="keyword">new</span> PhantomReference&lt;&gt;(object,phanQueue);</span><br><span class="line">        System.out.println(<span class="string">"创建的虚引用为："</span>+phanRef);</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> CheckRefQueue()).start();</span><br><span class="line"></span><br><span class="line">        object = <span class="keyword">null</span>;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> i =<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"第"</span>+i+++<span class="string">"次gc"</span>);</span><br><span class="line">            System.gc();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建的虚引用为：java.lang.ref.PhantomReference@3a6646fc</span><br><span class="line">第1次gc</span><br><span class="line">MyObject&apos;s finalize called</span><br><span class="line">第2次gc</span><br><span class="line">删除的虚引用为：java.lang.ref.PhantomReference@3a6646fc  but获取虚引用的对象obj.get()=null</span><br></pre></td></tr></table></figure>
<p> 可以看到，再经过一次GC之后，系统找到了垃圾对象，并调用finalize()方法回收内存，但没有立即加入回收队列。第二次GC时，该对象真正被GC清楚，此时，加入虚引用队列。<br>  虚引用的最大作用在于跟踪对象回收，清理被销毁对象的相关资源。<br>  通常当对象不被使用时，重载该对象的类的finalize方法可以回收对象的资源。但是如果使用不慎，会使得对象复活，譬如这么编写finalize方法：<br>  <br>  <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Test obj;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">        obj = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对上面这个类Test中obj = new Test();然后obj=null；之后调用System.gc()企图销毁对象，但是很抱歉，不管你调用多少次System.gc()都没有什么用，除非你在下面的代码中再就obj=null;这样才能回收对象，这是因为JVM对某一个对象至多只执行一次被重写的finalize方法。<br>  上面的小片段说明重写finalize的方法并不是很靠谱，可以使用虚引用来清理对象所占用的资源。<br>  如下代码所示：<br>  <br>  <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhantomRefTest2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReferenceQueue&lt;MyObject&gt; phanQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Reference&lt;MyObject&gt;,String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObject</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.finalize();</span><br><span class="line">            System.out.println(<span class="string">"MyObject's finalize called"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"I am MyObject"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckRefQueue</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        Reference&lt;MyObject&gt; obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                obj = (Reference&lt;MyObject&gt;)phanQueue.remove();</span><br><span class="line">                Object value = map.get(obj);</span><br><span class="line">                System.out.println(<span class="string">"clean resource:"</span>+value);</span><br><span class="line">                map.remove(obj);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"删除的虚引用为："</span>+obj+<span class="string">"  but获取虚引用的对象obj.get()="</span>+obj.get());</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyObject object = <span class="keyword">new</span> MyObject();</span><br><span class="line">        Reference&lt;MyObject&gt; phanRef = <span class="keyword">new</span> PhantomReference&lt;&gt;(object,phanQueue);</span><br><span class="line">        System.out.println(<span class="string">"创建的虚引用为："</span>+phanRef);</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> CheckRefQueue()).start();</span><br><span class="line">        map.put(phanRef, <span class="string">"Some Resources"</span>);</span><br><span class="line"></span><br><span class="line">        object = <span class="keyword">null</span>;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> i =<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"第"</span>+i+++<span class="string">"次gc"</span>);</span><br><span class="line">            System.gc();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">创建的虚引用为：java.lang.ref.PhantomReference@6a07348e</span><br><span class="line">第1次gc</span><br><span class="line">MyObject&apos;s finalize called</span><br><span class="line">第2次gc</span><br><span class="line">clean resource:Some Resources</span><br><span class="line">删除的虚引用为：java.lang.ref.PhantomReference@6a07348e  but获取虚引用的对象obj.get()=null</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-Compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-Compose/" itemprop="url">Docker Compose</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:34:32+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-Compose/" class="leancloud_visitors" data-flag-title="Docker Compose">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsy1fmufhxj30j50agju1.jpg" alt="image"><br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsy1g0w74ej30hy0b6wg6.jpg" alt="image"><br><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fsy1jqewqwj30jj0b9tc7.jpg" alt="image"></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fsy1xfo1tdj30mq0c5ju9.jpg" alt="image"></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fsy1y4fkbtj30lp0c7djj.jpg" alt="image"></p>
<p>远程 image 例如：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fsy1ovdmngj30mh0cf79r.jpg" alt="image"></p>
<p>本地 dockFile 例如：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsy1qccx18j30jw0cgmz9.jpg" alt="image"></p>
<p>详细说明：<br>示例1<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  wordpress:     <span class="comment">##container 名称</span></span><br><span class="line">    image: wordpress  <span class="comment">##image名称 远程的</span></span><br><span class="line">    ports:  <span class="comment">##端口映射</span></span><br><span class="line">      - <span class="number">8080</span>:<span class="number">80</span></span><br><span class="line">    environment:  <span class="comment">##环境变量</span></span><br><span class="line">      WORDPRESS_DB_HOST: mysql</span><br><span class="line">      WORDPRESS_DB_PASSWORD: root</span><br><span class="line">    networks:   <span class="comment">##指定网络</span></span><br><span class="line">      - my-bridge  <span class="comment">## 对应最下面的networks</span></span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">    volumes:  <span class="comment">##制定挂在目录</span></span><br><span class="line">      - mysql-data:/var/lib/mysql  <span class="comment">## mysql-data 对应下面的volumes</span></span><br><span class="line">    networks:</span><br><span class="line">      - my-bridge</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql-data:   <span class="comment">## 创建一个volumes</span></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  my-bridge:   <span class="comment">## 创建一个名为my-bridge的networks</span></span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure></p>
<p>示例2：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsy1u4l0ktj30nm0kwad6.jpg" alt="image"></p>
<p>docker-compose cli：<br><a href="http://www.cnblogs.com/liubin0509/p/6178351.html" target="_blank" rel="noopener">传送门</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="keyword">exec</span> mysql /bin/bash <span class="comment">##进去docker-compose中的mysql 执行/bin/bash</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-数据持久化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-数据持久化/" itemprop="url">Docker 数据持久化：Data Volume and Bind Mouting</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:33:33+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-数据持久化/" class="leancloud_visitors" data-flag-title="Docker 数据持久化：Data Volume and Bind Mouting">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>数据不会随着容器的消失而消失，例如 mysql ，redis</strong></p>
<p><strong>docker volume</strong></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fsx5mzmlprj30f005xabi.jpg" alt="image"></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fsx53ne9s0j30hz088wf7.jpg" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -v mysql:/var/lib/mysql --name mysql1 -e  MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个 mysql container 别名mysql ，挂载到宿主机的/var/lib/mysql下</span></span><br></pre></td></tr></table></figure>
<p><strong>docker bind mouting</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /home/aa:/root/aaa</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v $(pwd):/usr/share/nginx/html -p <span class="number">80</span>:<span class="number">80</span> --name web yefan/my-nginx</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-多机通讯/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-多机通讯/" itemprop="url">Docker 多机通讯</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:32:46+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-多机通讯/" class="leancloud_visitors" data-flag-title="Docker 多机通讯">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fswyvl9r6fj30l90cgju0.jpg" alt="image"></p>
<p><strong>etcd：</strong>  开源分布存储</p>
<h1 id="Mutil-host-networking-with-etcd"><a href="#Mutil-host-networking-with-etcd" class="headerlink" title="Mutil-host networking with etcd"></a>Mutil-host networking with etcd</h1><h2 id="setup-etcd-cluster"><a href="#setup-etcd-cluster" class="headerlink" title="setup etcd cluster"></a>setup etcd cluster</h2><p>在docker-node1上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node1:~$ wget https://github.com/coreos/etcd/releases/download/v3.0.12/etcd-v3.0.12-linux-amd64.tar.gz</span><br><span class="line">vagrant@docker-node1:~$ tar zxvf etcd-v3.0.12-linux-amd64.tar.gz</span><br><span class="line">vagrant@docker-node1:~$ cd etcd-v3.0.12-linux-amd64</span><br><span class="line">vagrant@docker-node1:~$ nohup ./etcd --name docker-node1 --initial-advertise-peer-urls http://192.168.205.10:2380 \</span><br><span class="line">--listen-peer-urls http://192.168.205.10:2380 \</span><br><span class="line">--listen-client-urls http://192.168.205.10:2379,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls http://192.168.205.10:2379 \</span><br><span class="line">--initial-cluster-token etcd-cluster \</span><br><span class="line">--initial-cluster docker-node1=http://192.168.205.10:2380,docker-node2=http://192.168.205.11:2380 \</span><br><span class="line">--initial-cluster-state new&amp;</span><br></pre></td></tr></table></figure>
<p>在docker-node2上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~$ wget https://github.com/coreos/etcd/releases/download/v3.0.12/etcd-v3.0.12-linux-amd64.tar.gz</span><br><span class="line">vagrant@docker-node2:~$ tar zxvf etcd-v3.0.12-linux-amd64.tar.gz</span><br><span class="line">vagrant@docker-node2:~$ cd etcd-v3.0.12-linux-amd64/</span><br><span class="line">vagrant@docker-node2:~$ nohup ./etcd --name docker-node2 --initial-advertise-peer-urls http://192.168.205.11:2380 \</span><br><span class="line">--listen-peer-urls http://192.168.205.11:2380 \</span><br><span class="line">--listen-client-urls http://192.168.205.11:2379,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls http://192.168.205.11:2379 \</span><br><span class="line">--initial-cluster-token etcd-cluster \</span><br><span class="line">--initial-cluster docker-node1=http://192.168.205.10:2380,docker-node2=http://192.168.205.11:2380 \</span><br><span class="line">--initial-cluster-state new&amp;</span><br></pre></td></tr></table></figure>
<p>检查cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~/etcd-v3.0.12-linux-amd64$ ./etcdctl cluster-health</span><br><span class="line">member 21eca106efe4caee is healthy: got healthy result from http://192.168.205.10:2379</span><br><span class="line">member 8614974c83d1cc6d is healthy: got healthy result from http://192.168.205.11:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>
<h2 id="重启docker服务"><a href="#重启docker服务" class="headerlink" title="重启docker服务"></a>重启docker服务</h2><p>在docker-node1上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker stop</span><br><span class="line">$ sudo /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --cluster-store=etcd://192.168.205.10:2379 --cluster-advertise=192.168.205.10:2375&amp;</span><br></pre></td></tr></table></figure>
<p>在docker-node2上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker stop</span><br><span class="line">$ sudo /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --cluster-store=etcd://192.168.205.11:2379 --cluster-advertise=192.168.205.11:2375&amp;</span><br></pre></td></tr></table></figure>
<h2 id="创建overlay-network"><a href="#创建overlay-network" class="headerlink" title="创建overlay network"></a>创建overlay network</h2><p>在docker-node1上创建一个demo的overlay network</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node1:~$ sudo docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">0e7bef3f143a        bridge              bridge              local</span><br><span class="line">a5c7daf62325        host                host                local</span><br><span class="line">3198cae88ab4        none                null                local</span><br><span class="line">vagrant@docker-node1:~$ sudo docker network create -d overlay demo</span><br><span class="line">3d430f3338a2c3496e9edeccc880f0a7affa06522b4249497ef6c4cd6571eaa9</span><br><span class="line">vagrant@docker-node1:~$ sudo docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">0e7bef3f143a        bridge              bridge              local</span><br><span class="line">3d430f3338a2        demo                overlay             global</span><br><span class="line">a5c7daf62325        host                host                local</span><br><span class="line">3198cae88ab4        none                null                local</span><br><span class="line">vagrant@docker-node1:~$ sudo docker network inspect demo</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;demo&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;3d430f3338a2c3496e9edeccc880f0a7affa06522b4249497ef6c4cd6571eaa9&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;global&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;overlay&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;10.0.0.0/24&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;10.0.0.1/24&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>我们会看到在node2上，这个demo的overlay network会被同步创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~$ sudo docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">c9947d4c3669        bridge              bridge              local</span><br><span class="line">3d430f3338a2        demo                overlay             global</span><br><span class="line">fa5168034de1        host                host                local</span><br><span class="line">c2ca34abec2a        none                null                local</span><br></pre></td></tr></table></figure>
<p>通过查看etcd的key-value, 我们获取到，这个demo的network是通过etcd从node1同步到node2的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~/etcd-v3.0.12-linux-amd64$ ./etcdctl ls /docker</span><br><span class="line">/docker/network</span><br><span class="line">/docker/nodes</span><br><span class="line">vagrant@docker-node2:~/etcd-v3.0.12-linux-amd64$ ./etcdctl ls /docker/nodes</span><br><span class="line">/docker/nodes/192.168.205.11:2375</span><br><span class="line">/docker/nodes/192.168.205.10:2375</span><br><span class="line">vagrant@docker-node2:~/etcd-v3.0.12-linux-amd64$ ./etcdctl ls /docker/network/v1.0/network</span><br><span class="line">/docker/network/v1.0/network/3d430f3338a2c3496e9edeccc880f0a7affa06522b4249497ef6c4cd6571eaa9</span><br><span class="line">vagrant@docker-node2:~/etcd-v3.0.12-linux-amd64$ ./etcdctl get /docker/network/v1.0/network/3d430f3338a2c3496e9edeccc880f0a7affa06522b4249497ef6c4cd6571eaa9 | jq .</span><br><span class="line">&#123;</span><br><span class="line">  &quot;addrSpace&quot;: &quot;GlobalDefault&quot;,</span><br><span class="line">  &quot;enableIPv6&quot;: false,</span><br><span class="line">  &quot;generic&quot;: &#123;</span><br><span class="line">    &quot;com.docker.network.enable_ipv6&quot;: false,</span><br><span class="line">    &quot;com.docker.network.generic&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;id&quot;: &quot;3d430f3338a2c3496e9edeccc880f0a7affa06522b4249497ef6c4cd6571eaa9&quot;,</span><br><span class="line">  &quot;inDelete&quot;: false,</span><br><span class="line">  &quot;ingress&quot;: false,</span><br><span class="line">  &quot;internal&quot;: false,</span><br><span class="line">  &quot;ipamOptions&quot;: &#123;&#125;,</span><br><span class="line">  &quot;ipamType&quot;: &quot;default&quot;,</span><br><span class="line">  &quot;ipamV4Config&quot;: &quot;[&#123;\&quot;PreferredPool\&quot;:\&quot;\&quot;,\&quot;SubPool\&quot;:\&quot;\&quot;,\&quot;Gateway\&quot;:\&quot;\&quot;,\&quot;AuxAddresses\&quot;:null&#125;]&quot;,</span><br><span class="line">  &quot;ipamV4Info&quot;: &quot;[&#123;\&quot;IPAMData\&quot;:\&quot;&#123;\\\&quot;AddressSpace\\\&quot;:\\\&quot;GlobalDefault\\\&quot;,\\\&quot;Gateway\\\&quot;:\\\&quot;10.0.0.1/24\\\&quot;,\\\&quot;Pool\\\&quot;:\\\&quot;10.0.0.0/24\\\&quot;&#125;\&quot;,\&quot;PoolID\&quot;:\&quot;GlobalDefault/10.0.0.0/24\&quot;&#125;]&quot;,</span><br><span class="line">  &quot;labels&quot;: &#123;&#125;,</span><br><span class="line">  &quot;name&quot;: &quot;demo&quot;,</span><br><span class="line">  &quot;networkType&quot;: &quot;overlay&quot;,</span><br><span class="line">  &quot;persist&quot;: true,</span><br><span class="line">  &quot;postIPv6&quot;: false,</span><br><span class="line">  &quot;scope&quot;: &quot;global&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建连接demo网络的容器"><a href="#创建连接demo网络的容器" class="headerlink" title="创建连接demo网络的容器"></a>创建连接demo网络的容器</h2><p>在docker-node1上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node1:~$ sudo docker run -d --name test1 --net demo busybox sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line">Unable to find image &apos;busybox:latest&apos; locally</span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line">56bec22e3559: Pull complete</span><br><span class="line">Digest: sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912</span><br><span class="line">Status: Downloaded newer image for busybox:latest</span><br><span class="line">a95a9466331dd9305f9f3c30e7330b5a41aae64afda78f038fc9e04900fcac54</span><br><span class="line">vagrant@docker-node1:~$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">a95a9466331d        busybox             &quot;sh -c &apos;while true; d&quot;   4 seconds ago       Up 3 seconds                            test1</span><br><span class="line">vagrant@docker-node1:~$ sudo docker exec test1 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:0A:00:00:02</span><br><span class="line">          inet addr:10.0.0.2  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::42:aff:fe00:2/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1</span><br><span class="line">          RX packets:15 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1206 (1.1 KiB)  TX bytes:648 (648.0 B)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 02:42:AC:12:00:02</span><br><span class="line">          inet addr:172.18.0.2  Bcast:0.0.0.0  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:acff:fe12:2/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:648 (648.0 B)  TX bytes:648 (648.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">vagrant@docker-node1:~$</span><br></pre></td></tr></table></figure>
<p>在docker-node2上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~$ sudo docker run -d --name test1 --net demo busybox sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line">Unable to find image &apos;busybox:latest&apos; locally</span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line">56bec22e3559: Pull complete</span><br><span class="line">Digest: sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912</span><br><span class="line">Status: Downloaded newer image for busybox:latest</span><br><span class="line">fad6dc6538a85d3dcc958e8ed7b1ec3810feee3e454c1d3f4e53ba25429b290b</span><br><span class="line">docker: Error response from daemon: service endpoint with name test1 already exists.</span><br><span class="line">vagrant@docker-node2:~$ sudo docker run -d --name test2 --net demo busybox sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line">9d494a2f66a69e6b861961d0c6af2446265bec9b1d273d7e70d0e46eb2e98d20</span><br></pre></td></tr></table></figure>
<p>验证连通性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vagrant@docker-node2:~$ sudo docker exec -it test2 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:0A:00:00:03</span><br><span class="line">          inet addr:10.0.0.3  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::42:aff:fe00:3/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1</span><br><span class="line">          RX packets:208 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:201 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:20008 (19.5 KiB)  TX bytes:19450 (18.9 KiB)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 02:42:AC:12:00:02</span><br><span class="line">          inet addr:172.18.0.2  Bcast:0.0.0.0  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:acff:fe12:2/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:648 (648.0 B)  TX bytes:648 (648.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">  vagrant@docker-node1:~$ sudo docker exec test1 sh -c &quot;ping 10.0.0.3&quot;</span><br><span class="line">  PING 10.0.0.3 (10.0.0.3): 56 data bytes</span><br><span class="line">  64 bytes from 10.0.0.3: seq=0 ttl=64 time=0.579 ms</span><br><span class="line">  64 bytes from 10.0.0.3: seq=1 ttl=64 time=0.411 ms</span><br><span class="line">  64 bytes from 10.0.0.3: seq=2 ttl=64 time=0.483 ms</span><br><span class="line">  ^C</span><br><span class="line">  vagrant@docker-node1:~$</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-Network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-Network/" itemprop="url">Docker Network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:31:54+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-Network/" class="leancloud_visitors" data-flag-title="Docker Network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>网络分层</strong><br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswr5yy1ryj30dm09bjv0.jpg" alt="image"></p>
<p><strong>内网用户需要访问外网资源-NAT 网络地址转换</strong><br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswrb7lwmpj30fs0ajwhp.jpg" alt="image"></p>
<p><strong>网络命名空间</strong><br>使用 network name space 实现网络空间隔离</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns list  <span class="comment">#查看本机的 network namespace</span></span><br><span class="line">sudo ip netns add test1 <span class="comment">#添加network namespace</span></span><br><span class="line">sudo ip netns delete name <span class="comment">#删除本机的 network namespace</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns <span class="keyword">exec</span> test1 ip a <span class="comment">#在 test1 network namespace 执行 ip a</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswsky6qfcj30xe062jse.jpg" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip link 类似 ip a</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns <span class="keyword">exec</span> test1 ip link set dev lo up <span class="comment">#设置test1的 lo 接口状态为 up(链接此接口的两端未连接的话，单个端口没法 up，必须为一对，单个端口状态为 UNKNOWN)</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fswsq8f7rhj314s02y0th.jpg" alt="image"></p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>要两个 namespace 能互相 ping 通<br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fswsu5vt9pj30ez09sab6.jpg" alt="image"><br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fswswc75inj30f309cjso.jpg" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,sudo ip link add veth-test1 type veth peer name veth-test2  <span class="comment">##宿主机执行，添加一对 veth。</span></span><br><span class="line"><span class="number">2</span>,sudo ip link set veth-test1 netns test1 <span class="comment">##将veth-test1添加到 test1 namespace</span></span><br><span class="line"><span class="number">3</span>,sudo ip link set veth-test2 netns test2 <span class="comment">##将veth-test2添加到 test2 namespace</span></span><br></pre></td></tr></table></figure>
<p>此时veth已经被添加到了 namespace 中<br><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fswt778bonj31ae09gwhl.jpg" alt="image"><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>，sudo ip netns <span class="keyword">exec</span> test1 ip addr add <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>/<span class="number">24</span> dev veth-test1 <span class="comment">#给 veth-test1添加 ip 地址</span></span><br><span class="line"><span class="number">5</span>, sudo ip netns <span class="keyword">exec</span> test2 ip addr add <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>/<span class="number">24</span> dev veth-test2 <span class="comment">#给 veth-test2添加 ip 地址</span></span><br><span class="line"><span class="number">6</span>, sudo ip netns <span class="keyword">exec</span> test1 ip link set dev veth-test1 up <span class="comment">#在 test1 的 namespace将veth-test1接口 状态改为 up</span></span><br><span class="line"><span class="number">7</span>, sudo ip netns <span class="keyword">exec</span> test2 ip link set dev veth-test2 up <span class="comment">#在 test2 的 namespace将veth-test2接口 状态改为 up</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fswte7ct0zj31i60gewkc.jpg" alt="image"><br>ping 通<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswtgnkt66j30yi0f4jv1.jpg" alt="image"></p>
<p><strong>docker network</strong></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fswq947ex3j308x077gmc.jpg" alt="image"></p>
<p><strong>docker network</strong> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker network  ls <span class="comment">##列举当前机器 docker 的网络</span></span><br><span class="line"></span><br><span class="line">sudo docker network inspect network_id <span class="comment">##列举当前网络详细信息</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fswwf2e5bpj315216y0zp.jpg" alt="image"></p>
<p><strong>brctl：</strong> 查看bridge 网络信息<br><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fswwlsuqmcj310c0iaad8.jpg" alt="image"></p>
<p>同一台宿主机中两个 docker 容器连接到bridge(docker0) 网络情况（绿色代表 veth 接口）：<br><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswwqkng1dj30i70cx0v4.jpg" alt="image"></p>
<p>容器如何访问外网的网络拓扑（利用 NAT）：<br><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fswwtdiai7j30mg0cfju7.jpg" alt="image"></p>
<p><strong>docke run –link:</strong> Add link to another container,可以根据容器名访问到另一个容器，不用指定 ip，如果是 mysql 直接可以使用类似 mysql://test:3306?user&amp;xxxx。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name test2 --link test1 busybox /bin/sh -c <span class="string">"while true; do sleep 3600; done"</span></span><br></pre></td></tr></table></figure>
<p><em>==link是单项的 test2 -&gt; test1 可以在 test2 上ping test1 ，不能反向==</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker network create -d bridge my-bridge <span class="comment">#新建 bridge</span></span><br><span class="line"></span><br><span class="line">sudo docker run -d --name test3 --network  my-bridge busybox /bin/sh -c <span class="string">"while true; do sleep 3600; done"</span> </span><br><span class="line"><span class="comment">## 新建容器连接到 my-bridge</span></span><br></pre></td></tr></table></figure>
<p><strong>docker network connect: </strong> 链接容器到一个网络上<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker network connect my-bridge test2 <span class="comment">##将 test1到my-bridge网络</span></span><br></pre></td></tr></table></figure></p>
<p>==<em>如果两个容器连接到了用户自己创建的 bridge 而不是默认的 bridge0上，默认两个容器已经–link 好了</em>==</p>
<h2 id="外网如何访问-container"><a href="#外网如何访问-container" class="headerlink" title="外网如何访问 container"></a>外网如何访问 container</h2><h4 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --name web -d -p <span class="number">80</span>:<span class="number">80</span> nginx <span class="comment">##创建一个名为 web 的 container 并且将容器的80 端口映射到宿主机的80端口</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fswy18rdjzj30ry08l3zp.jpg" alt="image"></p>
<p>此容器的网络拓扑<br><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fswy2ye7joj30hr0cwgnt.jpg" alt="image"></p>
<pre><code class="python">
</code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-Container-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-Container-introduce/" itemprop="url">Docker Container 简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:30:51+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-Container-introduce/" class="leancloud_visitors" data-flag-title="Docker Container 简介">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsvm2ziuswj30j10a80vu.jpg" alt="image"></p>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fsvm8eeb2mj31gm0ywn3b.jpg" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls  <span class="comment">##不包括退出的</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -a <span class="comment">##列举所有的容器，包括退出的</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a <span class="comment">##同上</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container rm <span class="number">8</span>dfc1a4e336e <span class="comment">##删除容器</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm <span class="number">8</span>dfc1a4e336e <span class="comment">##删除容器</span></span><br></pre></td></tr></table></figure>
<h3 id="docker-commit"><a href="#docker-commit" class="headerlink" title="docker commit"></a>docker commit</h3><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fsvnmimrqgj30zi0a8abq.jpg" alt="image"><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container commit  <span class="comment">##把容器 container commit 成一个新的 image</span></span><br></pre></td></tr></table></figure></p>
<p>例子：<br><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fsvnpl3y0lj31kw0k9n37.jpg" alt="image"></p>
<p><strong>docker exec :</strong> 进去正在运行的 docker shell 中</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">exec</span> -it d07a10a60a0b /bin/bash  <span class="comment">##进去d07a10a60a0b 的 shell 中</span></span><br><span class="line"></span><br><span class="line"> docker <span class="keyword">exec</span> -it d07a10a60a0b python  <span class="comment">##进去d07a10a60a0b 的 python</span></span><br><span class="line"> </span><br><span class="line">  docker <span class="keyword">exec</span> -it d07a10a60a0b ip a  <span class="comment">##进去d07a10a60a0b 显示网络接口</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker stop container_ID <span class="comment">##停止 container</span></span><br></pre></td></tr></table></figure>
<p><strong>docker run ：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name xxx</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fswq163tk9j31kw053tae.jpg" alt="image"></p>
<p><strong>docker container inspect :</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container inspect demo  <span class="comment">##显示容器的详细信息</span></span><br></pre></td></tr></table></figure>
<p><strong>docker container logs：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container logs demo <span class="comment">##显示 docker 容器运行日志</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/Docker-image-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Evan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evan's  技术blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/Docker-image-introduce/" itemprop="url">Docker image 简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-11T15:29:40+08:00">
                2018-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/11/Docker-image-introduce/" class="leancloud_visitors" data-flag-title="Docker image 简介">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-Image"><a href="#什么是-Image" class="headerlink" title="什么是 Image"></a>什么是 Image</h2><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fsviqv3u2ij30ix0a1dis.jpg" alt="image"></p>
<h2 id="docker命令"><a href="#docker命令" class="headerlink" title="docker命令"></a>docker命令</h2><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fsvjjztnuxj31c20ve79m.jpg" alt="image"></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fsvjkascaoj31fo160gua.jpg" alt="image"></p>
<h3 id="docker-image-的相关操作"><a href="#docker-image-的相关操作" class="headerlink" title="docker image 的相关操作"></a>docker image 的相关操作</h3><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fsvmpbsspej30y80k2jul.jpg" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull <span class="comment">##从register拉取image</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push <span class="comment">##push Image到register</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t yefan813/hello-world .  <span class="comment">##从DockerFile 构建一个 名为yefan813/hello-world的image ，‘.’是当前路径  （治理有个生成临时 container 的过程，然后 commit 成 一个 image，后删除临时的 container）</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run yefan813/hello-world <span class="comment">##从 image 启动一个容器</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it centos <span class="comment">##交互式标准输出运行一个容器</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image ls <span class="comment">##列出现有的image</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm <span class="number">8</span>dfc1a4e336e  <span class="comment">##删除image</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker history <span class="number">19452756</span>bcd1 <span class="comment">##查看image的分层</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi <span class="number">8</span>dfc1a4e336e  <span class="comment">##删除 image</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -aq <span class="comment">##列出 container id</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm $(docker container ls -aq) <span class="comment">##快速删除所有 container</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -f <span class="string">"status=exited"</span>  <span class="comment">##列出退出的 container</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -f <span class="string">"status=exited"</span> -q <span class="comment">##列出退出的 container的 id</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm $(docker container ls -f <span class="string">"status=exited"</span> -q) <span class="comment">##快速删除退出状态 container</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://ws2.sinaimg.cn/large/006tKfTcgy1ft4z5dtoyqj30qn0qnjsb.jpg"
                alt="Evan" />
            
              <p class="site-author-name" itemprop="name">Evan</p>
              <p class="site-description motion-element" itemprop="description">记录工作中的点滴，方便以后查阅，也能提升下文笔水平 :)</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Evan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("hhxOVlDXQ63y03ixWfnRLjw7-gzGzoHsz", "QyN5gx9XKuiE7LCLglTqWlHl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
